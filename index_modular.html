<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banquet Master v7.0 - Enterprise Edition</title>
    
    <!-- External Libraries (China CDN) -->
    <script src="https://cdn.staticfile.org/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.staticfile.org/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.staticfile.org/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.staticfile.org/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
</head>

<body>
    <!-- ========== v7.0: LOGIN SCREEN ========== -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-header">
                <h1>🍽️ Banquet Master</h1>
                <p class="version">v7.0 Enterprise Edition</p>
            </div>

            <div class="login-error" id="login-error">用户名或密码错误</div>

            <div class="login-input-group">
                <label>用户名</label>
                <input type="text" class="login-input" id="login-username" placeholder="输入用户名" autocomplete="username">
            </div>

            <div class="login-input-group">
                <label>密码</label>
                <input type="password" class="login-input" id="login-password" placeholder="输入密码"
                    autocomplete="current-password">
            </div>

            <button class="login-btn" onclick="app.login()">登录</button>

            <div
                style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #a0aec0; font-size: 12px;">
                <p>默认管理员账号: <strong>admin</strong> / <strong>admin123</strong></p>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- ========== SIDEBAR ========== -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <span>🍽️ Banquet Master</span>
                    <span class="brand-badge">v7.0</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Dashboard</div>
                    <div class="nav-item active" data-view="dashboard">
                        <i>📊</i>
                        <span>智能仪表盘</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">Workspace</div>
                    <div class="nav-item" data-view="menu">
                        <i>🍽️</i>
                        <span>宴请拟单</span>
                    </div>
                    <div class="nav-item" data-view="fruit">
                        <i>🍎</i>
                        <span>水果采购</span>
                    </div>
                </div>

                <div class="nav-group">
                    <div class="nav-group-title">System</div>
                    <div class="nav-item" data-view="settings">
                        <i>⚙️</i>
                        <span>系统设置</span>
                    </div>
                </div>
            </nav>

            <div class="cloud-status-panel">
                <div class="cloud-status">
                    <span class="status-dot online" id="status-dot"></span>
                    <span id="status-text">云端同步正常</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                    <button class="btn btn-sm"
                        style="font-size: 11px; padding: 6px 10px; background: rgba(255,255,255,0.1); color: white; border: none;"
                        onclick="app.cloudUpload()">
                        ☁️ 上传
                    </button>
                    <button class="btn btn-sm"
                        style="font-size: 11px; padding: 6px 10px; background: rgba(255,255,255,0.1); color: white; border: none;"
                        onclick="app.cloudDownload()">
                        📥 拉取
                    </button>
                </div>
            </div>
        </aside>

        <!-- ========== MAIN ========== -->
        <main class="main">
            <header class="header">
                <h1 id="view-title">智能仪表盘</h1>
                <div class="header-actions">
                    <button class="theme-toggle" id="theme-toggle" title="切换深色模式">
                        🌙
                    </button>
                    <div id="header-action-buttons"></div>
                </div>
            </header>

            <div class="content">
                <!-- ========== VIEW: DASHBOARD ========== -->
                <section id="view-dashboard" class="view active">
                    <!-- Calendar -->
                    <div class="calendar">
                        <div class="calendar-header">
                            <div class="calendar-nav">
                                <button onclick="app.prevMonth()">←</button>
                                <button onclick="app.nextMonth()">→</button>
                            </div>
                            <div class="calendar-title" id="calendar-title">2026年1月</div>
                            <button class="btn btn-primary btn-sm" onclick="app.newSession()">
                                ＋ 新建菜单
                            </button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Weekday headers will be inserted here -->
                        </div>
                    </div>

                    <!-- Dashboard Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">本月接待场次</div>
                            <div class="stat-value" id="stat-count">0</div>
                            <div class="stat-trend">场次</div>
                            <div class="sparkline"></div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">本月水果支出</div>
                            <div class="stat-value" id="stat-budget">¥0</div>
                            <div class="stat-trend">预估</div>
                            <div class="sparkline"></div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">最常接待部门</div>
                            <div class="stat-value" id="stat-dept">—</div>
                            <div class="stat-trend">Top Dept</div>
                            <div class="sparkline"></div>
                        </div>
                    </div>
                </section>

                <!-- ========== VIEW: MENU ========== -->
                <section id="view-menu" class="view">
                    <!-- Session Info -->
                    <div class="card">
                        <div class="form-row">
                            <div class="form-group">
                                <label>日期</label>
                                <input type="date" class="form-input" id="inp-date">
                            </div>
                            <div class="form-group">
                                <label>部门</label>
                                <input type="text" class="form-input" id="inp-dept" placeholder="销售部">
                            </div>
                            <div class="form-group">
                                <label>包厢</label>
                                <input type="text" class="form-input" id="inp-room" placeholder="V888">
                            </div>
                            <div class="form-group">
                                <label>桌数</label>
                                <input type="number" class="form-input" id="inp-tables" value="1" min="1">
                            </div>
                        </div>
                    </div>

                    <!-- Menu Sections -->
                    <div class="card">
                        <div id="menu-renderer"></div>

                        <!-- Kitchen Notes -->
                        <div class="kitchen-notes">
                            <label
                                style="display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">
                                🏷️ 厨房备注 (Kitchen Notes)
                            </label>
                            <textarea id="kitchen-notes" placeholder="例：无香菜、少盐、不要辣椒..."></textarea>
                        </div>

                        <!-- Cost Summary -->
                        <div class="cost-summary">
                            <div class="cost-item">
                                <div class="cost-label">单桌成本</div>
                                <div class="cost-value" id="cost-per-table">¥0</div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-label">总预算</div>
                                <div class="cost-value" id="cost-total">¥0</div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="menu-actions">
                            <button class="btn btn-secondary" onclick="app.saveTemplate()">
                                💾 存为模板
                            </button>
                            <button class="btn btn-secondary" onclick="app.loadTemplate()">
                                ⚡ 加载模板
                            </button>
                            <button class="btn btn-secondary" onclick="app.archiveCurrent()">
                                📥 归档
                            </button>
                            <button class="btn btn-primary" onclick="app.printMenu()">
                                🖨️ 打印菜单
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ========== VIEW: FRUIT ========== -->
                <section id="view-fruit" class="view">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="color: var(--text-secondary);">
                                <strong>预计人数:</strong> <span id="fruit-guests">10</span> 人
                                <span style="margin-left: 20px; color: var(--success);">■</span> 绿色 = 最低价
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="app.exportCSV()">
                                📥 导出 Excel
                            </button>
                            <button class="btn btn-success btn-sm admin-only" onclick="app.showProcurementSummary()">
                                📋 采购汇总
                            </button>
                        </div>

                        <div class="table-wrapper">
                            <table id="fruit-table">
                                <thead>
                                    <tr>
                                        <th style="width: 20%">水果名称</th>
                                        <th style="width: 12%">人均(kg)</th>
                                        <th style="width: 12%">总需(kg)</th>
                                        <th class="admin-only" style="width: 14%" contenteditable="true" id="sup-0">供应商
                                            A</th>
                                        <th class="admin-only" style="width: 14%" contenteditable="true" id="sup-1">供应商
                                            B</th>
                                        <th class="admin-only" style="width: 14%" contenteditable="true" id="sup-2">供应商
                                            C</th>
                                        <th class="admin-only" style="width: 14%">推荐采购</th>
                                    </tr>
                                </thead>
                                <tbody id="fruit-tbody">
                                    <!-- Rows will be inserted by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ========== VIEW: SETTINGS ========== -->
                <section id="view-settings" class="view">
                    <div class="card">
                        <h3 style="margin-bottom: 20px; font-size: 20px;">⚙️ 系统设置</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 28px;">
                            数据将自动同步至云端 (JSONBin)，无需手动配置。
                        </p>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="app.exportJSON()">
                                📥 导出本地备份
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('file-import').click()">
                                📤 导入备份
                            </button>
                            <input type="file" id="file-import" accept=".json" style="display: none"
                                onchange="app.importJSON(this)">
                            <button class="btn btn-danger" onclick="app.factoryReset()">
                                ⚠️ 恢复出厂
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- ========== MODALS ========== -->
    <div class="modal-overlay" id="modal-detail">
        <div class="modal">
            <div class="modal-title" id="modal-detail-title">详情</div>
            <div class="modal-body" id="modal-detail-body"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="app.closeModal('detail')">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-template">
        <div class="modal">
            <div class="modal-title">⚡ 选择模板</div>
            <div class="modal-body" id="modal-template-body"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="app.closeModal('template')">取消</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-procurement">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-title">📋 采购汇总 - 按供应商分组</div>
            <div class="modal-body" id="modal-procurement-body"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="app.closeModal('procurement')">关闭</button>
            </div>
        </div>
    </div>

    <!-- ========== TOAST ========== -->
    <div id="toast"></div>

    <!-- ========== PRINT OVERLAY ========== -->
    <div id="print-overlay"></div>


    <!-- Modular JavaScript -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
</body>

</html>
